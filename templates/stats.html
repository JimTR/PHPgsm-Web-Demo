<!--
   stats.html
   
   Copyright 2022 Jim Richardson <jim@noideersoftware.co.uk>
   
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2 of the License, or
   (at your option) any later version.
   
   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.
   
   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
   MA 02110-1301, USA.
   
   
-->

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta content="width=device-width, initial-scale=1.0" name="viewport">
		<title><!--#page-title#--></title>
		<meta content="" name="description">
		<meta content="" name="keywords">
		<!-- Favicons -->
		<link href="img/favicon.png" rel="icon">
		<link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
		<!-- Google Fonts -->
		<link href="https://fonts.gstatic.com" rel="preconnect">
		<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
		<!--#include#-->
	</head>
	<body>
		<!--#header#-->
		<!--#sidebar#-->
		<main id="main" class="main">
			<div class="pagetitle">
				<h1><!--#page-title#--></h1>
				
			</div><!-- End Page Title -->
		<section class="section">
			<ul class="nav nav-tabs nav-tabs-bordered" id="borderedTab" role="tablist" style="margin-bottom:1%;">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#bordered-home" type="button" role="tab" aria-controls="home" aria-selected="true"><i class="fa-solid fa-igloo"></i> General</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#bordered-profile" type="button" role="tab" aria-controls="profile" aria-selected="false"><i class="ri-base-station-line"></i> Player Lists</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#bordered-contact" type="button" role="tab" aria-controls="contact" aria-selected="false"><i class="bx bx-world"></i> Country Lists</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="supported-games" data-bs-toggle="tab" data-bs-target="#bordered-games" type="button" role="tab" aria-controls="contact" aria-selected="false"><i class="fa-solid fa-link"></i> Linked IP Addresses</button>
						</li>
						<!--<i class="fa-solid fa-user-slash"></i>-->
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="bans" data-bs-toggle="tab" data-bs-target="#bordered-bans" type="button" role="tab" aria-controls="contact" aria-selected="false"><i class="fa-solid fa-user-slash"></i> User Bans</button>
						</li>
						<li class="nav-item"><a class="nav-link" href="users.php"><i class="fa-solid fa-magnifying-glass"></i> Search Players</a></li>
						
					</ul>
			<div class="col-lg12">
				<div class="card">
					<div class="card-body">
						<div class="tab-content pt-2" id="borderedTabContent">
							<div class="tab-pane fade show active" id="bordered-home" role="tabpanel" aria-labelledby="home-tab">
								<div class="row">
								<div class="col-lg-6" id="stats" >
									<h5 class="card-title" style="margin-left:1%;">General Statistics</h5>
									<table class="table">
										<tr><td>Total Players</td><td colspan=2><!--#player_total#--></td></tr>
										<tr><td title="does not include current online players">Players have spent</td><td colspan=2> <!--#total_time#--> in game</td></tr>
										<tr><td>Top County</td><td><!--#country#--></td><td title="logins / players"><!--#country_stat#--></td></tr>
										<tr><td>Top Time Online</td><td><!--#time_online#--></td><td><!--#time_online_count#--></td></tr>
										<tr><td>Top Logins</td><td><!--#most_log_ons#--></td><td><!--#log_on_count#--></td></tr>
										<tr><td>Most logged into Server</td><td><!--#most_popular#--></td><td><!--#most_popular_count#--></td></tr>
										<tr><td>Most Played Server</td><td><!--#most_played#--></td><td><!--#most_played_time#--></td></tr>
										<tr><td>Comms Bans</td><td colspan=2><!--#comms_live#--> active bans out of <!--#comms_total#--> total</td></tr>
										<tr><td>Game Bans</td><td colspan=2><!--#game_live#--> active bans out of <!--#game_total#--> total</td></tr>
									</table>
								</div>
								<div class="col-lg-6" id="game_list" >
									<h5 class="card-title" style="margin-left:1%;">Server Use</h5>
									<table class="table">
										<tr><th>Server Name</th><th>In Game Time</th></tr>
										<!--#game_list#-->
									</table>
								</div>	
							</div>
							</div>
							<div class="tab-pane fade" id="bordered-profile" role="tabpanel" aria-labelledby="profile-tab">
								<div class="row">
									<div class="col-lg-6" id="searchbox">
										<h5 class="card-title" style="margin-left:1%;">Player Lists</h5>
										<form id="sendcmd"  action="<!--#url#-->/api.php" method="get">
											<input type="hidden" id="action" name="action" value="stats">
											<table class="table">
												<tr><td style="width:16%;border-style:none;">Start Date</td><td style="border-style:none;"><input style="width:11vw;" type="date" class="form-control" id="start" name="server"  value="<!--#today#-->"data-date-format="yyyy-mm-dd" ></td></tr>
												<tr style="border-top:0px;border-style:none;">
													<td style="border-top:0px;border-style:none;">End Date</td>
													<td style="border-top:0px;border-style:none;"><input style="width:11vw;" type="date" class="form-control" id="finish" name="filter"  value ="<!--#today#-->" data-date-format="yyyy-mm-dd"  ></td>
												</tr>
												<tr style="border-top:0px;border-style:none;">
													<td style="border-top:0px;border-style:none;" colspan=2>
														<span style="margin-left:23%;">
															<input class ="btn btn-primary" type ="submit" id="send" name="send" value ="Go"/>
														</span>
													</td>
												</tr>
											</table>	
										</form>
									</div>
									<div class="col-lg-12" style="display:none;" id="results">
						<!--<div class="card-body">-->
						<h5 class="card-title" style="margin-left:1%;">Results</h5>
							<p>Players for the period from <span id="starter"></span> to <span id="finisher"></span>  Total <span  id="count"></span></p> 
							<div class="table-wrapper" style="max-height:400px;">
								<table class="table table-sml" style="position: relative;">
									<thead>
										<tr style="padding-bottom:6px;">
											<th  style="width:25%;" class="table-header" >User</th>
											<th  class="table-header" >Location</th>
											<th class="table-header">Last Log On</th>
											<th class="table-header">Profile Link</th>
										</tr>
									</thead>	
									<tbody id="data_table"></tbody>
								</table>
					 		</div>
						</div>
					</div> <!-- row ?? -->
				</div> <!-- after row -->	
									<div class="tab-pane fade" id="bordered-contact" role="tabpanel" aria-labelledby="contact-tab">
								<div class="row">
									<div class="col-lg-3">
										<h5 class="card-title" style="margin-left:1%;">Country Lists</h5>
										<label for="country" style="padding-right:1%;">Select a Country</label>
										<select name="country" id="country" style="width:65%;">
											<!--#c_select#-->
										</select>
										<div id="country-stats" style="display:none;">
											<table class="table" style="margin-top:5%;">
												<tbody>
													<tr><td>Total Players</td><td id="c-rows"></td></tr>
													<tr><td>In Game</td><td id="online-time"></td></tr>
													<tr><td>Top Player</td><td id="online-player"></td></tr>
													<tr><td>Top Player Tiime</td><td id="online-player-time"></td></tr>
												</tbody>
											</table>
										</div>
									</div>
									<div class="col-lg-9" style="display:none;" id="country-results">
										<h5 class="card-title">Results For <span id="country-name"></span></h5>
										<div class="table-wrapper" style="max-height:400px;">
											<table class="table"  id="player-results">
												<thead>
													<th>Name</th><th>Location</th><th>Log ins</th><th>Last Login</th><th>Servers Played</th>
												</thead>
												<tbody id="country-body"></tbody>
											</table>
										</div>	
										<ul class="pagination" style="margin-top:1%;" id="country-pages"></ul>	
									</div>
									
								</div>
							</div>
							<div class="tab-pane fade" id="bordered-games" role="tabpanel" aria-labelledby="contact-tab">
								<div class="row">
									<div class="col-lg-8" id="">
										<h5 class="card-title" style="margin-left:1%;">Linked IP Addresses</h5>
										<p><!--#dup_count#--> accounts share IP addresses</p>
										<div class="table-wrapper">
										<table class="table">
											<thead>
												<th style="width:10%;">IP Address</th>
												<th style="width:29%;">Name</th>
												<th style="width:24%;padding-left:1.5%;">Last Login</th>
												<th style="width:10%;padding-left:4.5%;">Logins</th>
												<th style="text-align:right;padding-right:3%;">Ban Status</th>
												<!--<th>Last Logon</th>-->
											</thead>
											<!--#dups#-->
											
										</table>
										</div>
										
									</div>
									<div class="col-lg-4">
											<div id="key" style="margin-top: 30%;border: 1px solid; padding: 1%;text-align: center;">
												<table class="table no-border">
													<th colspan=2>Ban Key</th>
													<tr><td>Vac Ban</td><td><i class="fa-regular fa-circle-xmark" style="color:red;font-weight: 600;"></i></td></tr>
													<tr><td>Source Ban</td><td><i class="fa-regular fa-circle-xmark" style="color:#9b4c08;font-weight: 600;"></i></td></tr>
													<tr><td>System Ban IP</td><td><i class="fa-regular fa-circle-xmark" style="color:blue;font-weight: 600;"></i></td></tr>
													<tr><td>System Ban ID</td><td><i class="fa-regular fa-circle-xmark" style="color:#325f6e;font-weight: 600;"></i></td></tr>
												</table>
											</div>
										</div>	  
								</div>
							</div>
							<div class="tab-pane fade" id="bordered-bans" role="tabpanel" aria-labelledby="contact-tab">
								<div class="row">
									<h5 class="card-title" style="margin-left:1%;">Banned Users</h5>
									<div class="col-lg-4" id="">
										
										<p class="card-title">Vac Bans <!--#vac_count#--> bans found</p>
										<div class="table-wrapper">
										<table class="table">
											<thead>
												<th style="width:45%;">Name</th>
												<th style="width:30%;">Last Ban</th>
												<th>Last Login</th>
												<!--#vac_bans#-->
											</thead>
											
											
										</table>
										</div>
										</div>
										<div class="col-lg-4" id="">
										
										<p class="card-title">Source Bans <!--#sb_count#--> bans found</p>
										<div class="table-wrapper">
										<table class="table">
											<thead>
												<th style="width:45%;">Name</th>
												<th style="width:30%;">Last Ban</th>
												<th>Last Login</th>
												<!--#sb_bans#-->
											</thead>
											
											
										</table>
										</div>
										</div>
										<div class="col-lg-4" id="">
										
										<p class="card-title">System Bans</p>
										<div class="table-wrapper">
										<table class="table">
											<thead>
												<th style="width:10%;vertical-align:middle;">IP / userid</th>
												<th style="width:65%;text-align:center;">User Name<br> (if known)</th>
												<th>Last Login <br>(if known)</th>
												<!--#sys_bans#-->
											</thead>
											
											
										</table>
										</div>
									</div>	  
								</div>
							</div>
						</div>
						<div class="col-lg-12" style="margin-top:20px;text-align:right;"> 
							<!-- add second button -->
							<button  id="full-back" onclick="history.back();" type="button" class="btn btn-success <!--#button_class#-->">Go Back</button>
							<button  id="go_back"  style="display:none;" type="button" class="btn btn-success <!--#button_class#-->">Go Back</button>
						</div>	
					</div>
				</div>
			</div>
			<!-- popup -->
			<div class="modal fade" id="ban_user" tabindex="-1" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-dialog-centered modal-xl">
					<div class="modal-content">
						<div class="modal-header">
							<!--<h5 id="user-title" class="card-title">User Information</h5>-->
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
                       <iframe  style="width:100%; height:80vh;" id="ifrm" id="ifrm" src="" frameborder="0" >Your browser doesn't support iframes.</iframe>
					</div>
                </div>
            </div>
		</section>
		<!--#footer#-->					
			<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
   <script src = "js/jquery.js"></script>
   <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
   <script src = "assets/js/main.js"></script>
   <!--<script src = "js/console.js"></script>-->
 <script>
	var gdetail='';
	//console.log("on load "+history.length);
	$('#sendcmd').on('submit', function(e) {
		e.preventDefault();
		var items='';
		var url = $(this).attr('action');
		$("#data_table").html(items);
		var sndData = $('#sendcmd input').serialize();
		console.log(url)
		console.log(sndData);
		$.ajax({
			type: $(this).attr('method'),
			url: url,
			data: sndData,
			dataType: "json",
			success:  function(data){
				//console.log(data);
				if (data.count ==  0) {return}
					$("#searchbox").css("display","none");
					$("#results").css("display","block");
					$("#full-back").hide();
					$("#go_back").show();
					console.log(data.start);
					$('#count').html(data.count);
					$('#starter').html(data.start);
					$('#finisher').html(data.finish);
					player = data.results;
					$.each(player, function(i, item) {
						var timestamp =  timeConverter(item.last_log_on);
						gdetail += "<tr><td><a href='"+'users.php?id='+item.steam_id64+"'>"+item.name_c+"</a></td><td style='padding-left:2%;'><img  style='border:1px solid;width:40px;' src='"+item.flag+"' title='"+item.country+"'></td><td>"+timestamp+"</td><td>" ;
						gdetail +='<a href=http://steamcommunity.com/profiles/'+item.steam_id64+' target="_blank">'+item.steam_id64+'</a></td></tr>';
						man=item.name_c;
					});
					$("#data_table").html(gdetail);
					//console.log(gdetail)
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
				alert('failed '+textStatus);
			}
		});
	});
function timeConverter(UNIX_timestamp){
	var a = new Date(UNIX_timestamp * 1000);
	var months = ['January','Febuary','March','April','May','June','July','August','September','October','November','December'];
	var weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
	var year = a.getFullYear();
	var month = months[a.getMonth()];
	var day = weekday[a.getDay()];
	var date = a.getDate();
	var hour = a.getHours();
	var timeOfDay = ( hour < 12 ) ? "am" : "pm"; 
	currentHours = ( hour > 12 ) ? hour - 12 : hour;
	var d = a.getDate();
	var d1 =a.getHours();
	var d = ('0'+d).slice(-2);
	var m = a.getMonth()+1;
	var m = ('0'+m).slice(-2);
	var hour =('0'+hour).slice(-2);
    var y = a.getFullYear();
	var min = ('0'+a.getMinutes()).slice(-2);
	var sec = a.getSeconds();
	var time = d+ '-' + m + '-' + y + ' ' + hour + ':' + min ;
	return time;
}
$( "#go_back" ).click (function() {
	var rowCount = $('#data_table tr').length;
	console.log(rowCount);
	$('#results').hide();
	$('#searchbox').show();
	$("#data_table").empty();
	$("#gen").empty();
	$("#go_back").hide();
	$("#full-back").show();
	gendetail="";
	gdetail="";
});	
//$('th').click(function(){
//	var table = $(this).parents('table').eq(0)
//	var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
//	this.asc = !this.asc
//	if (!this.asc){rows = rows.reverse()}
//		for (var i = 0; i < rows.length; i++){table.append(rows[i])}
//})

function comparer(index) {
    return function(a, b) {
        var valA = getCellValue(a, index), valB = getCellValue(b, index)
        return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
    }
}

function getCellValue(row, index){ return $(row).children('td').eq(index).text() }
function loadIframe(iframeName, url) {
    var $iframe = $('#' + iframeName);
    if ($iframe.length) {
        $iframe.attr('src',url);
        return false;
    }
    return true;
}
$('.user-id').on("click",function(){
	console.log ("length "+history.length);
//console.log( this.parent());
  var usersid =  $(this).attr("id");
   loadIframe("ifrm", "frame.php?id="+usersid);
   $('#ban_user').modal('show');	
});
$("#country").change(function(){
	$("#country-body").empty();
	option = $('option:selected', this).attr('flag');
	val = $('option:selected', this).val();
	if(val == "none selected") {
		$("#country-name").text('');
		$("#country").blur();
		$("#country-results").hide();
		$("#country-stats").hide();
		return;
	}
	text = $('option:selected', this).text();
	url = "helpers/country.php?id="+val;
	console.log(url);
	$("#country-pages").hide();
	 $.ajax({ 
        type: 'GET', 
        url: url,
        dataType: "json", 
        success: function (data1) {
			// got data
			console.log(data1);
			$("#c-rows").text(data1.rows); 
			$("#online-time").text(data1.online);
			$("#online-player").text(data1.top_player);
			$("#online-player-time").text(data1.top_player_time);
			country = data1.country;
			if(data1.pages == 1) {$("#country-pages").hide();}
			
			else {
				$("#country-pages").empty();
				for (var counter = 0; counter < data1.pages; counter++) {
					console.log("in loop "+counter);
					realPage = counter+1;
					if (counter == data1.page) {
						//console.log ("we have the page to highlight "+counter);
						pageNo ='<li class="page-item"><span class="page-link" style="background-color: #2c2c;" url="helpers/country.php?id='+data1.id+'&page='+counter+'">'+realPage+'</span></li>';
					}
					else {
						pageNo ='<li class="page-item"><span class="page-link" url="helpers/country.php?id='+data1.id+'&page='+counter+'">'+realPage+'</span></li>';
					}
					$("#country-pages").append(pageNo);
				}
				$("#country-pages").show();
				//$("#country-pages").hide();
				
			}
			console.log(data1.pages); 
			console.log(country);
			
			for (var i in country) {
				//
				player= country[i];
				server = player.server.replace(/\*/g, ', ')
				cRow = "<tr  style='vertical-align:middle;' id='"+player.steam_id64+"'><td style='overflow:hidden;max-width: 150px;'><a href='users.php?id="+player.steam_id64+"'>"+player.name_c+"</a></td><td>"+player.city+" - "+player.region+"</td><td>"+player.log_ons+"</td><td>"+timeConverter(player.last_log_on)+"</td><td style='overflow:hidden;max-width: 150px;'>"+server+"</td></tr>";
				$('#player-results > tbody:last-child').append(cRow);
			}
		}
		
    });
	$("#country-name").text(text);
	$("#country").blur();
	$("#country-results").show();
	$("#country-stats").show();
});
function timeConverter(UNIX_timestamp){
	var a = new Date(UNIX_timestamp * 1000);
	var months = ['January','Febuary','March','April','May','June','July','August','September','October','November','December'];
	var weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
	var year = a.getFullYear();
	var month = months[a.getMonth()];
	var day = weekday[a.getDay()];
	var date = a.getDate();
	var hour = a.getHours();
	var timeOfDay = ( hour < 12 ) ? "am" : "pm"; 
	currentHours = ( hour > 12 ) ? hour - 12 : hour;
	var d = a.getDate();
	var d1 =a.getHours();
	var d = ('0'+d).slice(-2);
	var m = a.getMonth()+1;
	var m = ('0'+m).slice(-2);
	var hour =('0'+hour).slice(-2);
    var y = a.getFullYear();
	var min = ('0'+a.getMinutes()).slice(-2);
	var sec = a.getSeconds();
	var time = d+ '-' + m + '-' + y + ' ' + hour + ':' + min ;
	return time;
}
$('.page-link').on("click",function(){
	//
	console.log("entered click");

});
$(document).on('click','.page-link',function(){
//your code here
console.log("entered click");
	var url =  $(this).attr("url");
	console.log(url);
	
	$.ajax({ 
        type: 'GET', 
        url: url,
        dataType: "json", 
        success: function (data1) {
			// got data
			console.log(data1);
			country = data1.country;
			//$("#c-rows").text(data1.rows); 
			if(data1.pages == 1) {$("#country-pages").hide();} 
			else {
				$("#country-pages").empty();
				for (var counter = 0; counter < data1.pages; counter++) {
					console.log("in loop "+counter);
					realPage = counter+1;
					if (counter == data1.page) {
						pageNo ='<li class="page-item"><span class="page-link" style="background-color: #2c2c;" url="helpers/country.php?id='+data1.id+'&page='+counter+'">'+realPage+'</span></li>';
					}
					else{
						pageNo ='<li class="page-item"><span class="page-link" url="helpers/country.php?id='+data1.id+'&page='+counter+'">'+realPage+'</span></li>';
					}
					$("#country-pages").append(pageNo);
				}
				$("#country-pages").show();
			}
			console.log(data1.pages); 
			console.log(country);
			$("#country-body").empty();
			for (var i in country) {
				console.log('in loop reload');
				player= country[i];
				server = player.server.replace(/\*/g, ', ')
				cRow = "<tr  id='"+player.steam_id64+"'><td style='overflow:hidden;max-width: 150px;'><a href='users.php?id="+player.steam_id64+"'>"+player.name_c+"</a></td><td>"+player.city+" - "+player.region+"</td><td>"+player.log_ons+"</td><td>"+timeConverter(player.last_log_on)+"</td><td style='overflow:hidden;max-width: 150px;'>"+server+"</td></tr>";
				$('#player-results > tbody:last-child').append(cRow);
			}
		}
		
    });
});
 </script>